<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title>From HTML to Formly</title>
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css"/>
  <style>
    .my-messages {
      position: relative;
    }

    .some-message {
      color: #a94442;
      position: absolute;
      opacity: 1;
      transition: .3s linear all;
      font-size: .8em;
    }

    .some-message.ng-enter.ng-enter-active {
      opacity: 1;
      top: 0;
    }

    .some-message.ng-enter {
      opacity: 0;
      top: -20px;
    }

    .some-message.ng-leave {
      opacity: 1;
      top: 0;
    }

    .some-message.ng-leave-active {
      opacity: 0;
      top: -20px;
    }
  </style>
</head>
<body ng-app="app" ng-controller="MainCtrl as vm">
<div class="container">
  <h1>
    From HTML to Formly
    <br/>
    <small>
      A story of happiness and glee ~=[,,_,,]:3
    </small>
  </h1>
  <hr/>

  <div>
    <h2>Formly Form</h2>

    <form ng-submit="vm.onSubmit(vm.user)">
      <formly-form form="vm.userForm" model="vm.user" fields="vm.userFields">
        <button type="submit" class="btn btn-default" ng-disabled="vm.userForm.$invalid || vm.userForm.$pending">Submit</button>
      </formly-form>
    </form>
  </div>

  <hr/>
  <div>
    <h2>Model</h2>
    <pre>{{vm.user | json}}</pre>
  </div>
  <div>
    <h2>Error state</h2>
    <pre>{{vm.userForm.$error | json}}</pre>
  </div>
</div>

<script src="bower_components/angular/angular.js"></script>
<script src="bower_components/angular-animate/angular-animate.js"></script>
<script src="bower_components/angular-messages/angular-messages.js"></script>
<script src="bower_components/angular-aria/angular-aria.js"></script>
<script src="bower_components/angular-formly/dist/formly.js"></script>
<script src="bower_components/angular-formly-templates-bootstrap/dist/angular-formly-templates-bootstrap.js"></script>
<script>
  var app = angular.module('app', [
    'ngAnimate', 'ngMessages', 'ngAria',
    'formly', 'formlyBootstrap'
  ], function config(formlyConfigProvider) {
    formlyConfigProvider.setTemplate({
      fred: '<div>FRED!!!! <input ng-model="model[options.key]" /></div>'
    });
    formlyConfigProvider.setTemplateWrapper([
      {
        types: ['fred'],
        template: '<div><label for="{{::id}}">{{options.label}}</label><formly-transclude></formly-transclude></div>'
      }
    ]);
  });
  app.controller('MainCtrl', function($q, $timeout) {
    var vm = this;
    vm.genderOptions = [
      {name: 'Male', value: 'male'},
      {name: 'Female', value: 'female'},
      {name: 'Prefer not to say', value: 'unspecified'}
    ];
    vm.user = {};
    vm.userFields = [
      {
        type: 'fred',
        key: 'myFriendFred'
      },
      {
        key: 'firstName',
        type: 'text',
        label: 'First Name',
        placeholder: 'First Name',
        required: true,
        validators: {
          firstNameNotCoolEnough: checkFirstName
        }
      },
      {
        key: 'lastName',
        type: 'text',
        label: 'Last Name',
        placeholder: 'Last Name',
        expressionProperties: {
          required: 'model.firstName === "Danny"',
          disabled: function($viewValue, $modelValue, scope) {
            return scope.model.firstName === 'I hate formly';
          }
        }
      },
      {
        key: 'email',
        type: 'email',
        label: 'Email Address',
        placeholder: 'Email Address',
        required: true
      },
      {
        key: 'confirmEmail',
        type: 'email',
        label: 'Confirm Email Address',
        placeholder: 'Confirm Email Address',
        required: true,
        validators: {
          match: function($viewValue, $modelValue, scope) {
            var value = $modelValue || $viewValue;
            return scope.model.email === value;
          }
        }
      },
      {
        key: 'password',
        type: 'password',
        label: 'Password',
        placeholder: 'Password',
        required: true
      },
      {
        key: 'confirmPassword',
        type: 'password',
        label: 'Confirm Password',
        placeholder: 'Confirm Password',
        required: true
      },
      {
        key: 'gender',
        type: 'radio',
        label: 'Your Gender?',
        options: vm.genderOptions,
        required: true
      },
      {
        key: 'checked',
        type: 'checkbox',
        label: 'Do you sign your soul away to our TOS?',
        required: true
      },
      {
        template: '<span>Scott Rocks for realz</span>'
      }
    ];

    vm.onSubmit = onSubmit;

    function onSubmit(user) {
      alert(angular.toJson(user, 2));
    }

    function checkFirstName($viewValue, $modelValue) {
      var value = $modelValue || $viewValue;
      return $q(function(resolve, reject) {
        var resolveOrReject = value === 'Trogdor' ? resolve : reject;
        $timeout(resolveOrReject, (Math.random()*1000 + 2000));
      });
    }
    checkFirstName.isAsync = true;
  });

  app.directive('mustMatch', function() {
    return {
      require: 'ngModel',
      link: function(scope, el, attrs, ctrl) {
        ctrl.$validators.matches = matches;

        function matches(modelValue, viewValue) {
          var value = modelValue || viewValue;
          return value === scope.$eval(attrs.mustMatch);
        }
      }
    }
  });

  app.directive('myMessages', function() {
    return {
      templateUrl: 'custom-messages.html',
      scope: {field: '=myMessages'}
    }
  });

  app.directive('hasError', function() {
    return function(scope, el, attrs) {
      scope.$watch(attrs.hasError + '.$error', function(errors) {
        if (!scope.$eval(attrs.hasError + '.$touched')) {
          return;
        }
        if (errors && Object.keys(errors).length) {
          el.addClass('has-error');
        } else {
          el.removeClass('has-error');
        }
      }, true);
    }
  });
</script>

<script type="text/ng-template" id="custom-messages.html">
  <div class="my-messages" ng-messages="field.$error">
    <div class="some-message" ng-message="required">This field is required</div>
    <div class="some-message" ng-message="minlength">Input too short</div>
    <div class="some-message" ng-message="email">This field must be an email</div>
    <div class="some-message" ng-message="match">This field must match the other</div>
  </div>
</script>
</body>
</html>